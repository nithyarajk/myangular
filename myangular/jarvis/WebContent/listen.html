<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<script src="./resources/cb=gapi.loaded_0" async=""></script>
<script type="text/javascript" async=""
	src="./resources/plusone.js.download" gapi_processed="true"></script>
<script type="text/javascript" async="" src="./resources/ga.js.download"></script>
<script type='text/javascript' src="./resources/sdk.js"></script>
<script>
	(function(e, p) {
		var m = location.href.match(/platform=(win8|win|mac|linux|cros)/);
		e.id = (m && m[1])
				|| (p.indexOf('Windows NT 6.2') > -1 ? 'win8' : p
						.indexOf('Windows') > -1 ? 'win'
						: p.indexOf('Mac') > -1 ? 'mac'
								: p.indexOf('CrOS') > -1 ? 'cros' : 'linux');
		e.className = e.className.replace(/\bno-js\b/, 'js');
	})(document.documentElement, window.navigator.userAgent)
</script>

<meta content="initial-scale=1, minimum-scale=1, width=device-width"
	name="viewport">
<meta
	content="Google Chrome is a browser that combines a minimal design with sophisticated technology to make the web faster, safer, and easier."
	name="description">
<title>Am Listening...!!</title>
<link href="https://plus.google.com/100585555255542998765"
	rel="publisher">
<link href="https://www.google.com/images/icons/product/chrome-32.png"
	rel="icon" type="image/ico">



<style>
body {
	background: #ffffff url("./resources/office3.jpg") no-repeat right top;
	background-size: 100% 100%;
}

#info {
	font-size: 20px;
}

#div_start {
	float: right;
}

#headline {
	text-decoration: none
}

#results {
	font-size: 14px;
	font-weight: bold;
	border: 1px solid #ddd;
	padding: 15px;
	text-align: left;
	min-height: 150px;
	width: 500px;
	height: 500px;
	border-style: dashed;
	border-width: thin;
	border-radius: 10px;
	background-color: white;
}

#micDiv {
	background-color: white;
	border: 1px solid #ddd;
	padding: 15px;
	text-align: left;
	border-style: dashed;
	border-width: thin;
	border-radius: 10px;
	height: 60px;
}

#userSpan {
	background-color: white;
}

#start_button {
	border: 0;
	background-color: transparent;
	padding: 0;
	background-color: white;
}

.interim {
	color: gray;
}

.final {
	color: black;
	vertical-align: middle;
	font-family: monospace;
}

.question {
	color: black;
	font-family: monospace;
}

.round {
	color: gray;
	border-radius: 10px;
	vertical-align: middle;
	width: 50px;
	height: 50px;
}

.user {
	float: right;
	width: inherit;
	background-color: white;
}

.iva {
	width: inherit;
}
</style>
</head>
<body>

	<div id="demo"></div>
	<script>
	console.log("called");
		SDK.applicationId = "6929259702286656508";
		var sdk = new SDKConnection();
		var web = new WebAvatar();
		web.connection = sdk;
		web.avatar = "12601502";
		web.voice = "cmu-slt-hsmm"; 
		/* web.avatar = "14040617";
		web.voice = "jessica_voice-hsmm"; */
		web.voiceMod = "default";
		web.nativeVoice = true;
		web.nativeVoiceName = "Google US English";
		web.lang = "en-US";
		web.width = "450";
		web.height = "500";
		document.getElementById("demo").innerHTML = web.createBox();
		web.addMessage("");
		web.processMessages();
	</script>

	<div style="float: right">
		<div id="results">
			<span class="final" id="final_span"></span> <span class="iva"
				id="iva_span1" style="text-align: center; display: none"> <img
				class="round" src="./resources/iva.png" width="39" height="39" /> <span
				id="iva_text" class="final" id="iva_text"></span>
			</span> </br> <span class="user" id="user_span"
				style="text-align: right; display: none"> <span class="final"
				id="user_text"></span> <img class="round"
				src="./resources/userdp.png" width="39" height="39" />
			</span> </br>
		</div>
		<div id="micDiv" style="width: 500px; text-align: right;">
			<span class="user" id="user_span" style="text-align: right"> <span
				id="info_msg" style="font-size: 20px; color: #777;"> Click on
					the microphone icon and begin speaking. </span> <img id="input"
				class="round" name="mic" src="./resources/mic.png"
				onclick="toggleMic();" /><span> <!--button type="button" onclick="location.reload()">Clear</button-->
					<button type="button"
						onclick="document.getElementById('id01').style.display='block'">Clear</button>
			</span>
			</span>
		</div>
	</div>

	<script>

	var recognition = new webkitSpeechRecognition();
	recognition.continuous = true;

	recognition.onresult = function(event) {
		var interim_transcript = '';
		var final_transcript = ''

		for (var i = event.resultIndex; i < event.results.length; ++i) {
			if (event.results[i].isFinal) {
				final_transcript += event.results[i][0].transcript;
			} else {
				interim_transcript += event.results[i][0].transcript;
			}
		}
		console.log((new Date).toLocaleTimeString());
		final_transcript = final_transcript;
		populateUserText(final_transcript);
	}

	recognition.onerror = function(event) {
		console.log("Error");
	}

	recognition.onend = function() {
		console.log("On end");
		recognition.onresult(event);
	}

	function listen(event, greet) {
		recognition.lang = 'en-US';
		recognition.continious = true;
		recognition.interimResults = false;
		//recognition.maxAlternatives = 5;
		if(greet){
			greeting();
		}
		console.log((new Date).toLocaleTimeString());
		recognition.start();
	}

	function speech(text) {
		var u = new SpeechSynthesisUtterance();
		u.text = text;
		u.lang = 'en-US';
		u.rate = 0.5;
		web.addMessage(text);
		web.processMessages();
		//speechSynthesis.speak(u);
	}

	function greeting() {
		//var greeting = "Hello, I am Eva and will be assisting you today.";
		var greeting = "Hi, I'm Iva. I will guide you to select insurance according to your need. First, let me know a little about you. So, What is your name?";
		speech(greeting);
		popualteIvaGreeting(greeting);
	}

	var two_line = /\n\n/g;
	var one_line = /\n/g;
	function linebreak(s) {
		return s.replace(two_line, '<p></p>').replace(one_line, '<br>');
	}

	var first_char = /\S/;
	function capitalize(s) {
		return s.replace(first_char, function(m) {
			return m.toUpperCase();
		});
	}

	function toggleMic() {
		if (document.getElementById("input").name == 'mic') {
			document.getElementById("input").src = "./resources/stop.png";
			document.getElementById("input").name = 'stop';
			info_msg.innerHTML = "Listening. Click stop icon when you are done.";
			if(document.getElementById("iva_span1").style.display == "none"){
				listen(event,true);	
			}else{
				listen(event,false);
			}
		} else if (document.getElementById("input").name == 'stop') {
			document.getElementById("input").src = "./resources/mic.png";
			document.getElementById("input").name = 'mic';
			info_msg.innerHTML = "Click on the microphone icon and begin speaking.";
			recognition.stop();
		}
		//console.log(document.getElementById("input").name);
	}

	function popualteIvaGreeting(text) {
		document.getElementById("iva_span1").style.display = "";
		iva_text.innerHTML = capitalize(text);
	}
	
	function popualteIvaResponse(text) {
		results.innerHTML += '<span class=\"iva\" id=\"iva_span2\" style=\"text-align: center;\"> <img class=\"round\" src=\"./resources/iva.png\" width=\"39\" height=\"39\" /> <div style=\"display: inherit;\"><span id=\"iva_text2\" class=\"question\" id=\"iva_text\">'+text+'</span></div></span>\</br>';
	}

	var questionCount=1;
	function populateUserText(text) {
		if(document.getElementById("user_span").style.display == "none"){
			document.getElementById("user_span").style.display = "";
			user_text.innerHTML = capitalize(text);
			
			if (questionCount == 1) {
				var ans = text;
				var n = ans.split(" ");
				var name = n[n.length - 1];
				IvaSpeaking(name);
				questionCount++;
			}
			if (wait()) {
				//IvaSpeaking("");
			}

		} else {
			results.innerHTML += '<span class=\"user\" id=\"user_span2\" style=\"text-align: right;\"> <span id=\"user_text2\" class=\"final\" >'
					+ text
					+ '</span> <img class=\"round\" src=\"./resources/userdp.png\" width=\"39\" height=\"39\" /></span>\</br>';
			IvaSpeaking("");
		}
	}

	function wait() {
		var timeleft = 10;
		var downloadTimer = setInterval(function() {
			timeleft--;
			if (timeleft <= 0)
				clearInterval(downloadTimer);
		}, 1000);
		return true;
	}

	function IvaSpeaking(text) {
		if (text == "") {
			//var response = "Lets collect some quick information about yourself like name, age and location";
			var response = "Great Choice !! So this is going to be an insurance that allows protection as well as investments. Now let me start by asking your son's name";
		} else {
			response = "Hi " +text+" Good Morning !. So tell me what are you looking for?";
		}
		speech(response);
		popualteIvaResponse(response);
	}

	greeting();
</script>
</body>
</html>